<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">

  <title>JS Bin</title>
    <style>
    @font-face {
        font-family: "LyricovaJa";
        src: url("YuMincho+36pKana-Demibold.woff2") format("woff2"),
             url("YuMincho+36pKana-Demibold.woff") format("woff");
        font-weight: 600;
    }
    @font-face {
        font-family: "LyricovaZh";
        src: url("SongtiSC-Bold.woff2") format("woff2"),
             url("SongtiSC-Bold.woff") format("woff");
        font-weight: 600;
    }
    @font-face {
        font-family: "LyricovaEn";
        src: url("Cormorant-SemiBold.woff2") format("woff2"),
             url("Cormorant-SemiBold.woff") format("woff");
        font-weight: 600;
    }
    html, body{
      margin: 0;
      padding: 0;
    }
    .container{
      width: 100vw;
      height: 100vh;
      background-color: #212121;
      color: #bfbfbf;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }
    .left{
      flex-grow: 1;
      margin: 2rem 9rem 4rem 7rem;
      display: flex;
      flex-direction: column;
      position: relative;
      box-sizing: border-box;
    }
    .lyrics{
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .lyrics-body {
      font-size: 2.8rem;
      overflow: hidden;
    }
    .lyrics-body:lang(ja) p,.lyrics-caption:lang(ja){
      font-family: "LyricovaJa", "YuMincho +36p Kana", serif;
      font-weight: 600;
    }
    .lyrics-body:lang(zh) p,.lyrics-caption:lang(zh){
      font-family: "LyricovaEn", "LyricovaZh", Cormorant, "Songti SC", serif;
      font-weight: 600;
    }
    .lyrics-body:lang(en) p,.lyrics-caption:lang(en),.credit{
      font-family: "LyricovaEn", Cormorant, serif;
      font-size: 1.2em;
      font-weight: 600;
    }
    .lyrics-body p{
      margin: 0.25rem 0;
      padding: 0;
      min-height: .25em;
    }
    .lyrics-body .typing:lang(ja){
      padding-bottom: 10px;
      border-bottom: 2px solid;
    }
    .lyrics-body .typing:lang(zh){
      padding-bottom: 3px;
      border-bottom: 2px solid;
    }
    .lyrics-body p:last-child::after{
      content: "|";
      animation: 1s linear 0s infinite blink;
      padding-left: 0.125em;
    }
    .left::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 3em;
        background: linear-gradient(to bottom, rgba(33,33,33,1) 0%,rgba(33,33,33,0) 100%);
    }
    @keyframes blink{
      0% {opacity: 1;}
      49% {opacity: 1;}
      50% {opacity: 0;}
      100%{opacity: 0;}
    }
    .lyrics-caption{
      margin-top: 0.5rem;
      font-size: 1.2rem;
    }
    .right{
      position: relative;
    }
    .clock{
      position: absolute;
      right: -0.2em;
      top: -0.05em;
      writing-mode: vertical-lr;
      -webkit-writing-mode: vertical-lr;
      font-family: Roboto, sans-serif;
      font-weight: 900;
      font-size: 25vh;
      opacity: 0.5;
    }
    span.badge::after{
      display: inline-block;
      font-size: .8em;
      font-family: Roboto;
      font-weight: bold;
      padding: 0.2em 0.7em;
      border-radius: 0.35em;
      text-transform: uppercase;
      color: #fff;
      margin-left: 0.7em;
    }
    span.badge.core::after{
      content: "Core";
      border: 1px solid #9E9E9E;
      color: #9E9E9E;
    }
    span.badge.dark::after{
      content: "Dark";
      border: 1px solid #AFB8E2;
      color: #AFB8E2;
    }
    span.badge.light::after{
      content: "Light";
      border: 1px solid #29B6F6;
      color: #29B6F6;
    }
    span.badge.soft::after{
      content: "Soft";
      border: 1px solid #BA68C8;
      color: #BA68C8;
    }
    span.badge.vivid::after{
      content: "Vivid";
      border: 1px solid #7CB342;
      color: #7CB342;
    }
    span.badge.sweet::after{
      content: "Sweet";
      border: 1px solid #F06292;
      color: #F06292;
    }
    span.badge.solid::after{
      content: "Solid";
      border: 1px solid #78909C;
      color: #78909C;
    }
    </style>
</head>
<body>
    <div class="container">
      <div class="left">
        <div class="lyrics">
          <div class="lyrics-body" lang="ja">
            <p>ラタタ　タリ　タイプライター</p>
            <p>遥か深く眠る宇宙で</p>
            <p>ラタタ　タリ　タイプライター</p>
            <p>重なった心を<span class="typing">まっていｒ</span></p>
          </div>
          <div class="lyrics-caption" lang="ja">
            TypeWriter by Hario feat. 重音テト
            <span class="badge vivid"></span>
          </div>
        </div>
        <div class="credit">
          Project Lyricova Screensaver
        </div>
      </div>
      <div class="right">
        <div class="clock">12:34:56</div>
      </div>
    </div>
    <script>
window.onerror = function(msg, url, linenumber) {
    document.getElementsByClassName("credit")[0].innerHTML =
    'Error message: '+msg+'<br>\nURL: '+url+'<br>\nLine Number: '+linenumber;
    return true;
}

</script><script id="jsbin-javascript" type="text/javascript">
!function(e,t,n){typeof module!="undefined"&&module.exports?module.exports=n():typeof define=="function"&&define.amd?define(n):t[e]=n()}("reqwest",this,function(){function succeed(e){var t=protocolRe.exec(e.url);return t=t&&t[1]||context.location.protocol,httpsRe.test(t)?twoHundo.test(e.request.status):!!e.request.response}function handleReadyState(e,t,n){return function(){if(e._aborted)return n(e.request);if(e._timedOut)return n(e.request,"Request is aborted: timeout");e.request&&e.request[readyState]==4&&(e.request.onreadystatechange=noop,succeed(e)?t(e.request):n(e.request))}}function setHeaders(e,t){var n=t.headers||{},r;n.Accept=n.Accept||defaultHeaders.accept[t.type]||defaultHeaders.accept["*"];var i=typeof FormData!="undefined"&&t.data instanceof FormData;!t.crossOrigin&&!n[requestedWith]&&(n[requestedWith]=defaultHeaders.requestedWith),!n[contentType]&&!i&&(n[contentType]=t.contentType||defaultHeaders.contentType);for(r in n)n.hasOwnProperty(r)&&"setRequestHeader"in e&&e.setRequestHeader(r,n[r])}function setCredentials(e,t){typeof t.withCredentials!="undefined"&&typeof e.withCredentials!="undefined"&&(e.withCredentials=!!t.withCredentials)}function generalCallback(e){lastValue=e}function urlappend(e,t){return e+(/\?/.test(e)?"&":"?")+t}function handleJsonp(e,t,n,r){var i=uniqid++,s=e.jsonpCallback||"callback",o=e.jsonpCallbackName||reqwest.getcallbackPrefix(i),u=new RegExp("((^|\\?|&)"+s+")=([^&]+)"),a=r.match(u),f=doc.createElement("script"),l=0,c=navigator.userAgent.indexOf("MSIE 10.0")!==-1;return a?a[3]==="?"?r=r.replace(u,"$1="+o):o=a[3]:r=urlappend(r,s+"="+o),context[o]=generalCallback,f.type="text/javascript",f.src=r,f.async=!0,typeof f.onreadystatechange!="undefined"&&!c&&(f.htmlFor=f.id="_reqwest_"+i),f.onload=f.onreadystatechange=function(){if(f[readyState]&&f[readyState]!=="complete"&&f[readyState]!=="loaded"||l)return!1;f.onload=f.onreadystatechange=null,f.onclick&&f.onclick(),t(lastValue),lastValue=undefined,head.removeChild(f),l=1},head.appendChild(f),{abort:function(){f.onload=f.onreadystatechange=null,n({},"Request is aborted: timeout",{}),lastValue=undefined,head.removeChild(f),l=1}}}function getRequest(e,t){var n=this.o,r=(n.method||"GET").toUpperCase(),i=typeof n=="string"?n:n.url,s=n.processData!==!1&&n.data&&typeof n.data!="string"?reqwest.toQueryString(n.data):n.data||null,o,u=!1;return(n["type"]=="jsonp"||r=="GET")&&s&&(i=urlappend(i,s),s=null),n["type"]=="jsonp"?handleJsonp(n,e,t,i):(o=n.xhr&&n.xhr(n)||xhr(n),o.open(r,i,n.async===!1?!1:!0),setHeaders(o,n),setCredentials(o,n),context[xDomainRequest]&&o instanceof context[xDomainRequest]?(o.onload=e,o.onerror=t,o.onprogress=function(){},u=!0):o.onreadystatechange=handleReadyState(this,e,t),n.before&&n.before(o),u?setTimeout(function(){o.send(s)},200):o.send(s),o)}function Reqwest(e,t){this.o=e,this.fn=t,init.apply(this,arguments)}function setType(e){if(e===null)return undefined;if(e.match("json"))return"json";if(e.match("javascript"))return"js";if(e.match("text"))return"html";if(e.match("xml"))return"xml"}function init(o,fn){function complete(e){o.timeout&&clearTimeout(self.timeout),self.timeout=null;while(self._completeHandlers.length>0)self._completeHandlers.shift()(e)}function success(resp){var type=o.type||resp&&setType(resp.getResponseHeader("Content-Type"));resp=type!=="jsonp"?self.request:resp;var filteredResponse=globalSetupOptions.dataFilter(resp.responseText,type),r=filteredResponse;try{resp.responseText=r}catch(e){}if(r)switch(type){case"json":try{resp=context.JSON?context.JSON.parse(r):eval("("+r+")")}catch(err){return error(resp,"Could not parse JSON in response",err)}break;case"js":resp=eval(r);break;case"html":resp=r;break;case"xml":resp=resp.responseXML&&resp.responseXML.parseError&&resp.responseXML.parseError.errorCode&&resp.responseXML.parseError.reason?null:resp.responseXML}self._responseArgs.resp=resp,self._fulfilled=!0,fn(resp),self._successHandler(resp);while(self._fulfillmentHandlers.length>0)resp=self._fulfillmentHandlers.shift()(resp);complete(resp)}function timedOut(){self._timedOut=!0,self.request.abort()}function error(e,t,n){e=self.request,self._responseArgs.resp=e,self._responseArgs.msg=t,self._responseArgs.t=n,self._erred=!0;while(self._errorHandlers.length>0)self._errorHandlers.shift()(e,t,n);complete(e)}this.url=typeof o=="string"?o:o.url,this.timeout=null,this._fulfilled=!1,this._successHandler=function(){},this._fulfillmentHandlers=[],this._errorHandlers=[],this._completeHandlers=[],this._erred=!1,this._responseArgs={};var self=this;fn=fn||function(){},o.timeout&&(this.timeout=setTimeout(function(){timedOut()},o.timeout)),o.success&&(this._successHandler=function(){o.success.apply(o,arguments)}),o.error&&this._errorHandlers.push(function(){o.error.apply(o,arguments)}),o.complete&&this._completeHandlers.push(function(){o.complete.apply(o,arguments)}),this.request=getRequest.call(this,success,error)}function reqwest(e,t){return new Reqwest(e,t)}function normalize(e){return e?e.replace(/\r?\n/g,"\r\n"):""}function serial(e,t){var n=e.name,r=e.tagName.toLowerCase(),i=function(e){e&&!e.disabled&&t(n,normalize(e.attributes.value&&e.attributes.value.specified?e.value:e.text))},s,o,u,a;if(e.disabled||!n)return;switch(r){case"input":/reset|button|image|file/i.test(e.type)||(s=/checkbox/i.test(e.type),o=/radio/i.test(e.type),u=e.value,(!s&&!o||e.checked)&&t(n,normalize(s&&u===""?"on":u)));break;case"textarea":t(n,normalize(e.value));break;case"select":if(e.type.toLowerCase()==="select-one")i(e.selectedIndex>=0?e.options[e.selectedIndex]:null);else for(a=0;e.length&&a<e.length;a++)e.options[a].selected&&i(e.options[a])}}function eachFormElement(){var e=this,t,n,r=function(t,n){var r,i,s;for(r=0;r<n.length;r++){s=t[byTag](n[r]);for(i=0;i<s.length;i++)serial(s[i],e)}};for(n=0;n<arguments.length;n++)t=arguments[n],/input|select|textarea/i.test(t.tagName)&&serial(t,e),r(t,["input","select","textarea"])}function serializeQueryString(){return reqwest.toQueryString(reqwest.serializeArray.apply(null,arguments))}function serializeHash(){var e={};return eachFormElement.apply(function(t,n){t in e?(e[t]&&!isArray(e[t])&&(e[t]=[e[t]]),e[t].push(n)):e[t]=n},arguments),e}function buildParams(e,t,n,r){var i,s,o,u=/\[\]$/;if(isArray(t))for(s=0;t&&s<t.length;s++)o=t[s],n||u.test(e)?r(e,o):buildParams(e+"["+(typeof o=="object"?s:"")+"]",o,n,r);else if(t&&t.toString()==="[object Object]")for(i in t)buildParams(e+"["+i+"]",t[i],n,r);else r(e,t)}var context=this;if("window"in context)var doc=document,byTag="getElementsByTagName",head=doc[byTag]("head")[0];else{var XHR2;try{XHR2=require("xhr2")}catch(ex){throw new Error("Peer dependency `xhr2` required! Please npm install xhr2")}}var httpsRe=/^http/,protocolRe=/(^\w+):\/\//,twoHundo=/^(20\d|1223)$/,readyState="readyState",contentType="Content-Type",requestedWith="X-Requested-With",uniqid=0,callbackPrefix="reqwest_"+ +(new Date),lastValue,xmlHttpRequest="XMLHttpRequest",xDomainRequest="XDomainRequest",noop=function(){},isArray=typeof Array.isArray=="function"?Array.isArray:function(e){return e instanceof Array},defaultHeaders={contentType:"application/x-www-form-urlencoded",requestedWith:xmlHttpRequest,accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",js:"application/javascript, text/javascript"}},xhr=function(e){if(e.crossOrigin===!0){var t=context[xmlHttpRequest]?new XMLHttpRequest:null;if(t&&"withCredentials"in t)return t;if(context[xDomainRequest])return new XDomainRequest;throw new Error("Browser does not support cross-origin requests")}return context[xmlHttpRequest]?new XMLHttpRequest:XHR2?new XHR2:new ActiveXObject("Microsoft.XMLHTTP")},globalSetupOptions={dataFilter:function(e){return e}};return Reqwest.prototype={abort:function(){this._aborted=!0,this.request.abort()},retry:function(){init.call(this,this.o,this.fn)},then:function(e,t){return e=e||function(){},t=t||function(){},this._fulfilled?this._responseArgs.resp=e(this._responseArgs.resp):this._erred?t(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(e),this._errorHandlers.push(t)),this},always:function(e){return this._fulfilled||this._erred?e(this._responseArgs.resp):this._completeHandlers.push(e),this},fail:function(e){return this._erred?e(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(e),this},"catch":function(e){return this.fail(e)}},reqwest.serializeArray=function(){var e=[];return eachFormElement.apply(function(t,n){e.push({name:t,value:n})},arguments),e},reqwest.serialize=function(){if(arguments.length===0)return"";var e,t,n=Array.prototype.slice.call(arguments,0);return e=n.pop(),e&&e.nodeType&&n.push(e)&&(e=null),e&&(e=e.type),e=="map"?t=serializeHash:e=="array"?t=reqwest.serializeArray:t=serializeQueryString,t.apply(null,n)},reqwest.toQueryString=function(e,t){var n,r,i=t||!1,s=[],o=encodeURIComponent,u=function(e,t){t="function"==typeof t?t():t==null?"":t,s[s.length]=o(e)+"="+o(t)};if(isArray(e))for(r=0;e&&r<e.length;r++)u(e[r].name,e[r].value);else for(n in e)e.hasOwnProperty(n)&&buildParams(n,e[n],i,u);return s.join("&").replace(/%20/g,"+")},reqwest.getcallbackPrefix=function(){return callbackPrefix},reqwest.compat=function(e,t){return e&&(e.type&&(e.method=e.type)&&delete e.type,e.dataType&&(e.type=e.dataType),e.jsonpCallback&&(e.jsonpCallbackName=e.jsonpCallback)&&delete e.jsonpCallback,e.jsonp&&(e.jsonpCallback=e.jsonp)),new Reqwest(e,t)},reqwest.ajaxSetup=function(e){e=e||{};for(var t in e)globalSetupOptions[t]=e[t]},reqwest});

(function(){
  setInterval(function(){
    var a = new Date();
    document.getElementsByClassName("clock")[0].innerText =  ('0' + a.getHours()).slice(-2) + ":" + ('0' + a.getMinutes()).slice(-2) + ":" + ('0' + a.getSeconds()).slice(-2);
  },100);
})();

// fontsize: 25.2 * no_lines em if lines > 10
window.lyrics = [];
window.title = "";
window.category = [];
window.lyrics_lang = "";
window.data = {"0":{
    "romanize": {
        "ja": [
                [['信じたものは', 'しんじたものは']],
                [['都合のいい妄想を', 'つごうのいいもうそうを']],
                [['繰り返し', 'くりかえし'], ['映し出す', 'うつしだす'], ['鏡', 'かがみ']]
            ]
    },
    "languages": {
        "ja": "信じたものは\n都合のいい妄想を\n繰り返し映し出す鏡"
    },
    "title": "初音ミクの消失 by cosMo@暴走P",
    "category": ["core"]
}};

// window.data = {"0":{
//     "romanize": {
//         "ja": "",
//         "zh": [[["鈍銹","dun'xiu"],["的","de"],["氣息","qi'xi"],["、","、"]],[["甚至","shen'zhi"],["熏染","xun'ran"],["的","de"],["漆黑","qi'hei"],["也","ye"],[" "," "]],[["終於開始","zhong'yu'kai'shi"],["變得","bian'de"]],[["淡","dan"],["了","le"],["起來","qi'lai"],[" "," "]],[["好像","hao'xiang"],["聽到","ting'dao"],["了","le"],["某處","mou'chu"],["傳來","chuan'lai"],["的","de"],["聲音","sheng'yin"],[" "," "]],[["像是","xiang'shi"],["很","hen"],["熟悉","shu'xi"],["　","　"]],[["又","you"],["像是","xiang'shi"],["忘掉","wang'diao"],["了","le"],["的","de"],[" "," "]],[["在","zai"],["螺旋","luo'xuan"],["階梯","jie'ti"],["的","de"]],[["盡頭","jin'tou"],["是","shi"],[" "," "]],[["十分","shi'fen"],["狹小的門","xia'xiao'de'men"],[" "," "]],[["正","zheng"],["於","yu"],["塵埃中","chen'ai'zhong"]],[["等待","deng'dai"],["著","zhe"]],[],[["「","「"],["我","wo"],["推開","tui'kai"],["囉","luo"],["。","。"],["」","」"]],[["「","「"],["嗯","n"],["。","。"],["」","」"]]]
//     },
//     "languages": {
//         "en": "",
//         "ja": "",
//         "zh": "aa"
//     },
//     "title": "初音ミクの消失 by cosMo@暴走P",
//     "category": ["core"]
// }};

window.picker = [["0", "zh"]];

var api_base_path = "../api/";

var local_storage_api = "http://localhost/storage/";

window.config = {
    "local_storage_api": true,
    "ja": ["all"],
    "en": ["all"],
    "zh": ["all"],
}

var storage_set = function(key, value){
    if (window.config['local_storage_api']){
        localStorage.setItem(key, value);
    } else {
        var d = {};
        d[key] = value;
        reqwest({url: local_storage_api, method: "post", data: d});
    }
}

var storage_get = function(key){
    if (window.config['local_storage_api']){
        return localStorage.getItem(key);
    } else {
        return reqwest({url: local_storage_api + "?" + key, method: "get", async: false}).request.response.replace(/\n/g, "\\n");
    }
}

var load_data = function(){
    var last_update = storage_get("lyricova_last_update");
    window.data = storage_get("lyricova_data");
    window.data = window.data ? JSON.parse(data) : {};
    load_picker();
    reqwest({
        url: api_base_path + "last_update"
    }).then(
        function(val){
            storage_set("lyricova_last_update", val);
            if (!last_update || parseInt(last_update) < parseInt(val)){
                var query = api_base_path + "get_data";
                // Update available
                if (last_update) {
                    query += "?timestamp=" + last_update;
                }
                reqwest({
                    url: query
                }).then(function(val){
                    var ndata = val;
                    for (var i in ndata) window.data[i] = ndata[i];
                    storage_set("lyricova_data", JSON.stringify(data));
                    load_picker();
                });
            }
        }
    );
};

var load_picker = function(){
    window.picker = [];
    for (var i in window.data){
        if (window.data[i]['languages']['ja'] && match_category(window.data[i]['category'], window.config['ja'])){
            window.picker.push([i, 'ja']);
        }
        if (window.data[i]['languages']['en'] && match_category(window.data[i]['category'], window.config['en'])){
            window.picker.push([i, 'en']);
        }
        if (window.data[i]['languages']['zh'] && match_category(window.data[i]['category'], window.config['zh'])){
            window.picker.push([i, 'zh']);
        }
    }
}

var match_category = function(cates, allowed){
    if (allowed[0] == "all") return true;
    for (var i of cates){
        if (allowed.indexOf(i) >= 0) return true;
    }
    return false;
}

var load_config = function(){
    if (window.location.hash.length > 1){
        conf = JSON.parse(window.location.hash.substring(1));
        for (var i in conf){
            window.config[i] = conf[i];
        }
    }
}

var JaMap = {
	romanMapSingle: {
		'あ': '', 'い': '', 'う': '', 'え': '', 'お': '',
		'か': 'ｋ', 'き': 'ｋ', 'く': 'ｋ', 'け': 'ｋ', 'こ': 'ｋ',
		'さ': 'ｓ', 'し': 'ｓ', 'す': 'ｓ', 'せ': 'ｓ', 'そ': 'ｓ',
		'た': 'ｔ', 'ち': 'ｔ', 'つ': 'ｔ', 'て': 'ｔ', 'と': 'ｔ',
		'な': 'ｎ', 'に': 'ｎ', 'ぬ': 'ｎ', 'ね': 'ｎ', 'の': 'ｎ',
		'は': 'ｈ', 'ひ': 'ｈ', 'ふ': 'ｆ', 'へ': 'ｈ', 'ほ': 'ｈ',
		'ま': 'ｍ', 'み': 'ｍ', 'む': 'ｍ', 'め': 'ｍ', 'も': 'ｍ',
		'や': 'ｙ', 'ゆ': 'ｙ', 'よ': 'ｙ',
		'ら': 'ｒ', 'り': 'ｒ', 'る': 'ｒ', 'れ': 'ｒ', 'ろ': 'ｒ',
		'わ': 'ｗ', 'を': 'ｗ', 'ん': 'ｎ',
		'が': 'ｇ', 'ぎ': 'ｇ', 'ぐ': 'ｇ', 'げ': 'ｇ', 'ご': 'ｇ',
		'ざ': 'ｚ', 'じ': 'ｊ', 'ず': 'ｚ', 'ぜ': 'ｚ', 'ぞ': 'ｚ',
		'だ': 'ｄ', 'ぢ': 'ｄ', 'づ': 'ｄ', 'で': 'ｄ', 'ど': 'ｄ',
		'ば': 'ｂ', 'び': 'ｂ', 'ぶ': 'ｂ', 'べ': 'ｂ', 'ぼ': 'ｂ',
		'ぱ': 'ｐ', 'ぴ': 'ｐ', 'ぷ': 'ｐ', 'ぺ': 'ｐ', 'ぽ': 'ｐ',
		'ぁ': 'ｘ', 'ぃ': 'ｘ', 'ぅ': 'ｘ', 'ぇ': 'ｘ', 'ぉ': 'ｘ',
		'っ': 'ｘｔ',
		'ゃ': 'ｘｙ', 'ゅ': 'ｘｙ', 'ょ': 'ｘｙ',
		'ゎ': 'ｘｗ'
	},
	romanMapDouble: {
		'きゃ': 'ｋｙ', 'きゅ': 'ｋｙ', 'きぇ': 'ｋｙ', 'きょ': 'ｋｙ',
		'くぁ': 'ｋｗ',
		'しゃ': 'ｓｙ', 'しゅ': 'ｓｙ', 'しぇ': 'ｓｙ', 'しょ': 'ｓｙ',
		'ちゃ': 'ｔｙ', 'ちゅ': 'ｔｙ', 'ちぇ': 'ｔｙ', 'ちょ': 'ｔｙ',
		'てゃ': 'ｔｈ', 'てぃ': 'ｔｈ', 'てゅ': 'ｔｈ', 'てぇ': 'ｔｈ', 'てょ': 'ｔｈ',
		'にゃ': 'ｎｙ', 'にゅ': 'ｎｙ', 'にぇ': 'ｎｙ', 'にょ': 'ｎｙ',
		'ひゃ': 'ｈｙ', 'ひゅ': 'ｈｙ', 'ひぇ': 'ｈｙ', 'ひょ': 'ｈｙ',
		'みゃ': 'ｍｙ', 'みゅ': 'ｍｙ', 'みぇ': 'ｍｙ', 'みょ': 'ｍｙ',
		'りゃ': 'ｒｙ', 'りゅ': 'ｒｙ', 'りぇ': 'ｒｙ', 'りょ': 'ｒｙ',
		'うぃ': 'ｗ', 'うぇ': 'ｗ',
		'ぎゃ': 'ｇｙ', 'ぎゅ': 'ｇｙ', 'ぎぇ': 'ｇｙ', 'ぎょ': 'ｇｙ',
		'じゃ': 'ｊ', 'じゅ': 'ｊ', 'じぇ': 'ｊ', 'じょ': 'ｊ',
		'ぢゃ': 'ｄｙ', 'ぢゅ': 'ｄｙ', 'ぢぇ': 'ｄｙ', 'ぢょ': 'ｄｙ',
		'びゃ': 'ｂｙ', 'びゅ': 'ｂｙ', 'びぇ': 'ｂｙ', 'びょ': 'ｂｙ',
		'ぴゃ': 'ｐｙ', 'ぴゅ': 'ｐｙ', 'ぴぇ': 'ｐｙ', 'ぴょ': 'ｐｙ'
	},
	kanaMap: {
		'ア': 'あ', 'イ': 'い', 'ウ': 'う', 'エ': 'え', 'オ': 'お',
		'カ': 'か', 'キ': 'き', 'ク': 'く', 'ケ': 'け', 'コ': 'こ',
		'サ': 'さ', 'シ': 'し', 'ス': 'す', 'セ': 'せ', 'ソ': 'そ',
		'タ': 'た', 'チ': 'ち', 'ツ': 'つ', 'テ': 'て', 'ト': 'と',
		'ナ': 'な', 'ニ': 'に', 'ヌ': 'ぬ', 'ネ': 'ね', 'ノ': 'の',
		'ハ': 'は', 'ヒ': 'ひ', 'フ': 'ふ', 'ヘ': 'へ', 'ホ': 'ほ',
		'マ': 'ま', 'ミ': 'み', 'ム': 'む', 'メ': 'め', 'モ': 'も',
		'ヤ': 'や', 'ユ': 'ゆ', 'ヨ': 'よ',
		'ラ': 'ら', 'リ': 'り', 'ル': 'る', 'レ': 'れ', 'ロ': 'ろ',
		'ワ': 'わ', 'ヲ': 'を', 'ン': 'ん',
		'ガ': 'が', 'ギ': 'ぎ', 'グ': 'ぐ', 'ゲ': 'げ', 'ゴ': 'ご',
		'ザ': 'ざ', 'ジ': 'じ', 'ズ': 'ず', 'ゼ': 'ぜ', 'ゾ': 'ぞ',
		'ダ': 'だ', 'ヂ': 'ぢ', 'ヅ': 'づ', 'デ': 'で', 'ド': 'ど',
		'バ': 'ば', 'ビ': 'び', 'ブ': 'ぶ', 'ベ': 'べ', 'ボ': 'ぼ',
		'パ': 'ぱ', 'ピ': 'ぴ', 'プ': 'ぷ', 'ペ': 'ぺ', 'ポ': 'ぽ',
		'ァ': 'ぁ', 'ィ': 'ぃ', 'ゥ': 'ぅ', 'ェ': 'ぇ', 'ォ': 'ぉ',
		'ッ': 'っ',
		'ャ': 'ゃ', 'ュ': 'ゅ', 'ョ': 'ょ',
		'ヮ': 'ゎ'
	}
};

var anim_ja = function(word){
    var res = word[0];
    var query = "";

    // Convert to Hiragana
    for (var i = 0; i < word[1].length; i++) {
        query += JaMap.kanaMap[word[1][i]] || word[1][i];
    }
    var done = "";
    var anim = [true];
    while (query.length > 0) {
        // Matching double kana set.
        if (query.length >= 2 && JaMap.romanMapDouble[query.substr(0, 2)]) {
            for (var i = 1; i <= JaMap.romanMapDouble[query.substr(0, 2)].length; i++) {
                anim.push(done + JaMap.romanMapDouble[query.substr(0, 2)].substr(0, i));
            }
            anim.push(done + query.substr(0, 2));
            done += query.substr(0, 2);
            query = query.substring(2, query.length);
        } else if (query.length >= 2 && query[0] == "っ" && JaMap.romanMapSingle[query[1]]) {
            anim.push(done + JaMap.romanMapSingle[query[1]][0]);
            done += "っ";
            query = query.substring(1, query.length);
            // matching single char
        } else if (JaMap.romanMapSingle[query[0]] !== undefined) {
            for (var i = 1; i <= JaMap.romanMapSingle[query[0]].length; i++) {
                anim.push(done + JaMap.romanMapSingle[query[0]].substr(0, i));
            }
            anim.push(done + query[0]);
            done += query[0];
            query = query.substring(1, query.length);
        } else {
            done += query[0];
            anim.push(done);
            query = query.substring(1, query.length);
        }
    }
    anim.push(res);
    return anim;
};

var anim_zh = function(word){
    var res = [word[0] !== word[1]];
    var curr = "";
    var py = word[1];
    while (py.length > 0) {
        chr = py[0];
        py = py.substring(1, py.length);
        curr += chr;
        if (chr !== "'"){
            res.push(curr);
        }
    }
    if (res[res.length - 1] !== word[0]){
        res.push(word[0]);
    }
    return res;
};

var anim_en = function(line){
    res = [false]
    for (var i = 1; i <= line.length; i++){
        res.push(line.substring(0, i))
    }
    return res;
}

var prepare_anim_seq = function(){
    window.animationSeq = [];


    for (var ln of lyrics) {
        window.animationSeq.push([]);
        for (var word of ln) {
            if (window.lyrics_lang == "ja") {
                window.animationSeq[window.animationSeq.length - 1].push(anim_ja(word));
            } else if (window.lyrics_lang == 'zh') {
                window.animationSeq[window.animationSeq.length - 1].push(anim_zh(word));
            } else if (window.lyrics_lang == 'en') {
                window.animationSeq[window.animationSeq.length - 1].push(anim_en(word))
            }
        }
    }

	var elem = document.getElementsByClassName("lyrics-body")[0];
	while (elem.lastChild) {
	    elem.removeChild(elem.lastChild);
	}
	elem.setAttribute("lang", window.lyrics_lang);
	var p = document.createElement("p");
	elem.appendChild(p);
	var span = document.createElement("span");
	if (window.animationSeq[0][0][0]) span.className = "typing";
    window.animationSeq[0][0].shift();
	p.appendChild(span);

    var title = document.getElementsByClassName("lyrics-caption")[0];
    title.innerText = window.title + " ";
    document.title = window.title + " - Project Lyricova";
    for (var i of window.category){
        var badge = document.createElement("span");
        badge.className = "badge " + i;
        title.appendChild(badge);
    }
};

var animate = function(){
    var elem = document.getElementsByClassName("lyrics-body")[0];
    var lyrics = document.getElementsByClassName("lyrics")[0];

    if (window.animationSeq.length > 0) { // If animation sequence is ready
        if (window.animationSeq[0].length == 0){ // new line
            if (window.animationSeq.length > 1){
                var p = document.createElement("p");
                elem.appendChild(p);
                var span = document.createElement("span");
                if (window.animationSeq[1].length > 0){
                    if (window.animationSeq[1][0][0]) span.className = "typing";
                    window.animationSeq[1][0].shift();
                }
                p.appendChild(span);
            }
            window.animationSeq.shift();
        } else { // continue with last line
            if (window.animationSeq[0][0].length == 0){
                window.animationSeq[0].shift();
                var row = elem.lastChild;
                row.lastChild.className = "";
                if (window.animationSeq[0].length > 0){
                    var span = document.createElement("span");
                    var last_word = window.animationSeq[0][0];
                    if (window.animationSeq[0][0][0]){
                        span.className = "typing";
                    }
                    window.animationSeq[0][0].shift();
                    row.appendChild(span);
                }
            } else {
                var span = elem.lastChild.lastChild;
                span.innerText = window.animationSeq[0][0].shift();
            }
        }
    } else { // Item finished
        clearInterval(window.globalTimer);
        setTimeout(done, 5000);
    }
    elem.scrollTop = elem.scrollHeight;
};

var done = function() {
    if (window.picker.length < 1) load_picker();
    var picked_i = Math.floor(Math.random() * window.picker.length);
    var picked = window.picker.splice(picked_i, 1)[0];
    window.title = window.data[picked[0]]['title'];
    window.category = window.data[picked[0]]['category'];
    window.lyrics_lang = picked[1];
    if (picked[1] == 'en'){
        var lrc = [];
        for (var i of window.data[picked[0]]['languages']['en'].replace(/<.*?>/g, '').split('\n'))
            lrc.push([i]);
        window.lyrics = lrc;
    } else {
        window.lyrics = window.data[picked[0]]['romanize'][picked[1]];
    }
    prepare_anim_seq();
    window.globalTimer = setInterval(animate, 150);
};

var main = function() {
    load_config();

    load_data();
    done();
};

main();
</script>
</body>
</html>
